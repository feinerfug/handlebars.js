#!/usr/bin/env ruby

require 'rubygems'
require 'bundler/setup'
require 'thor'
require 'v8'

class HandlebarsCommand < Thor
  desc "compile DIR_NAME", "compile all of the template files in the given directory"
  method_option :prefix, :type => :string, :default => "Handlebars.Templates"
  method_option :out, :type => :string, :desc => "Output file for compiled templates, by default output is written to STDOUT"
  def compile(directory)
    
    if !File.directory?(directory)
      puts "  ERROR: The given template directory doesn't exist."
      exit
    end
    
    files = Dir["#{directory}/**/*.hbs"]
    if files.empty?
      puts "  ERROR: No template files were found."
      exit
    end
    
    ctx = V8::Context.new
    ctx.load(File.dirname(__FILE__) + "/../dist/handlebars.js")
    
    target = $stdout
    if options[:out]
      target = File.open(options[:out], "w")
    end
    
    puts "  Compiling #{files.length} templates..." if options[:out]
    
    files.each do |file|
      puts "    #{file}..." if options[:out]
      method = file.gsub(Regexp.new("^#{directory}"), "")
      method.gsub!(/\.hbs$/, "")
      method.gsub!(/\/+/, ".")
      
      template = File.read(file)
      
      ctx["template"] = template;
      compiled = ctx.eval("Handlebars.compile(template).source.toString();")
      
      target << "var #{options[:prefix]}#{method} = #{compiled};\n\n"
    end
    
    target.close if options[:out]
  end
end

HandlebarsCommand.start